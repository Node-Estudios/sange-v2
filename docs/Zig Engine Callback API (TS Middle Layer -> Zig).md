This section defines the logical functions that the TypeScript Middle Layer must implement and provide to the Zig Engine (likely via the `callbacks` parameter in `create_stream`). Zig will call these functions asynchronously during stream processing.
### Purpose of the Callback API

The Zig Engine operates asynchronously. Once the TypeScript Middle Layer initiates an operation like `play_stream`, the Zig engine performs complex, time-based tasks in the background (reading data, decoding, encoding, packetizing).

This callback interface is essential for the following reasons:

1. **Asynchronous Data & Event Handling:** Results (like ready-to-send RTP packets) and significant events (like the end of a stream or playback errors) are generated _within_ the Zig engine _during_ its background processing. There needs to be a mechanism for Zig to communicate this information back to TypeScript _as it happens_.
2. **Bridging the Language Gap:** TypeScript needs to act on the information generated by Zig. Specifically, the TypeScript Middle Layer is responsible for sending RTP packets over the network using the Discord voice UDP connection and for managing the state of the stream from the application's perspective. Zig itself should not handle network I/O specific to Discord or manage TypeScript application state. Callbacks provide the bridge for Zig to deliver the necessary data and events across the language boundary (via Zigar) to the TypeScript code that _can_ act on them.
3. **Efficiency (Push vs. Poll):** Instead of requiring TypeScript to constantly ask Zig "Is there a packet ready? Is the status updated?" (polling), the callback mechanism allows Zig to efficiently "push" information to TypeScript immediately when it's available. This is generally more performant and responsive for event-driven systems like audio streaming.
4. **Decoupling:** This interface decouples the Zig engine's internal processing logic from the TypeScript layer's responsibilities (network communication, high-level state management). Zig focuses on audio processing; TypeScript focuses on integration with Discord and the application logic.

In essence, the callbacks allow the asynchronous, high-performance Zig engine to feed the necessary real-time information back to the TypeScript environment where it can be appropriately handled.

---

- **`on_rtp_packet(stream_id: u64, packet_data: []const u8, sequence: u16, timestamp: u32, is_silence: bool)`**
    
    - **Description:** Called by Zig whenever a new RTP packet is ready to be sent.
    - **Parameters (provided by Zig):**
        - `stream_id`: The unique identifier originally provided by TS, allowing TS to know which stream this packet belongs to.
        - `packet_data`: The raw bytes of the Opus-encoded RTP packet. (Zigar will likely marshal this as a `Buffer` or `Uint8Array` in TS).
        - `sequence`: The RTP sequence number for the packet.
        - `timestamp`: The RTP timestamp for the packet.
        - `is_silence`: A boolean indicating if the packet represents silence (useful for Discord's speaking indicator).
    - **TS Implementation Responsibility:** Forward the `packet_data` to the correct Discord voice UDP connection for transmission.
- **`on_stream_status(stream_id: u64, status_code: StreamStatusCode, details: ?string)`**
    
    - **Description:** Called by Zig when a significant status change occurs for the stream.
    - **Parameters (provided by Zig):**
        - `stream_id`: The unique identifier for the relevant stream.
        - `status_code`: An enum or identifier representing the new status (e.g., `Playing`, `Paused`, `Buffering`, `Ended`, `Error`, `Stopped`).
        - `details`: An optional string providing more context, especially for errors.
    - **TS Implementation Responsibility:** Update the internal state representation of the stream in the TS Middle Layer. Trigger necessary actions based on the status (e.g., initiate cleanup via `destroy_stream` if `Ended` or `Error`, notify the TS High Level Layer).

---